<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- ç§»åŠ¨ç«¯ä¼˜åŒ– -->  
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
<!-- éšè— iOS æµè§ˆå™¨æ  -->  
<meta name="apple-mobile-web-app-capable" content="yes">  
<meta name="apple-mobile-web-app-status-bar-style" content="black">  
<!-- éšè—å®‰å“ Chrome æµè§ˆå™¨æ  -->  
<meta name="mobile-web-app-capable" content="yes">  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸‰9ç­æ™ºèƒ½è¯­éŸ³è·‘åœˆè®¡æ•°å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰</title>
    <!-- å¼•å…¥æ‹¼éŸ³åº“ï¼Œç”¨äºå¤„ç†åŒéŸ³å­—åŒ¹é… -->
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --danger-color: #f44336;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --highlight-color: #2196F3;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #333; margin-bottom: 20px; text-align: center; }

        /* æ§åˆ¶é¢æ¿åŒºåŸŸ */
        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .panel-top {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .voice-status {
            font-weight: bold;
            color: #666;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }

        .voice-status.listening { color: var(--primary-color); }
        .voice-status.listening::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin-right: 8px;
            box-shadow: 0 0 8px var(--primary-color);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        button {
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: white;
            font-weight: 500;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: scale(0.98); }

        .btn-start { background-color: var(--primary-color); font-size: 16px; padding: 12px 24px; }
        .btn-stop { background-color: #9e9e9e; }
        .btn-global-add { background-color: var(--highlight-color); }
        .btn-global-reset { background-color: var(--danger-color); }
        .btn-fix { background-color: #FF9800; animation: fadeIn 0.5s; }

        /* å†å²è®°å½•ä¸ä¿®æ­£æ  */
        .history-bar {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #0d47a1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            min-height: 40px;
        }
        .history-info { font-weight: bold; }

        /* ç…§ç‰‡æŸ¥çœ‹åŒºåŸŸ */
        .photo-area {
            border-top: 2px dashed #ddd;
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .photo-input-label {
            background-color: #607D8B;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
        }
        .photo-gallery img {
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #eee;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-gallery img:hover { transform: scale(1.5); z-index: 10; border-color: var(--primary-color); }

        /* å­¦ç”Ÿåˆ—è¡¨ç½‘æ ¼ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 1200px;
        }

        .student-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .student-card.just-updated {
            background-color: #e8f5e9;
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .student-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; color: #333; }
        .lap-display { font-size: 2.5em; font-weight: bold; color: var(--primary-color); margin: 5px 0; }
        
        .card-controls { display: flex; gap: 5px; margin-top: 10px; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-add { background-color: var(--primary-color); }
        .btn-sub { background-color: #FF9800; }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal select {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>ğŸƒâ€â™‚ï¸ åˆä¸‰9ç­æ™ºèƒ½è¯­éŸ³è·‘åœˆè®¡æ•°å™¨</h1>

    <div class="control-panel">
        <div class="panel-top">
            <div id="voiceStatus" class="voice-status">ğŸ™ï¸ è¯­éŸ³æœªå¯åŠ¨</div>
            <button onclick="toggleSpeech()" id="voiceBtn" class="btn-start">å¼€å§‹ç›‘å¬</button>
            <div style="flex-grow: 1;"></div>
            <button onclick="globalChange(1)" class="btn-global-add">å…¨ç­ +1</button>
            <button onclick="globalReset()" class="btn-global-reset">å…¨ç­æ¸…é›¶</button>
            <button onclick="resetRecognitionMap()" style="background-color:#999">æ¸…é™¤å­¦ä¹ æ•°æ®</button>
        </div>

        <!-- å†å²ä¸ä¿®æ­£æ  -->
        <div id="historyBar" class="history-bar" style="display:none;">
            <span id="historyText" class="history-info"></span>
            <button id="fixBtn" class="btn-fix" onclick="triggerFix()">âŒ æ’¤å›å¹¶ä¿®æ­£</button>
        </div>

        <!-- ç…§ç‰‡åŒºåŸŸ -->
        <div class="photo-area">
            <label class="photo-input-label">
                ğŸ“· æ·»åŠ ç­çº§ç…§ç‰‡ (æ”¯æŒå¤šå¼ )
                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotos(this)">
            </label>
            <div class="photo-gallery" id="photoGallery"></div>
        </div>
    </div>

    <div class="grid-container" id="studentGrid"></div>

    <!-- ä¿®æ­£å¼¹çª— -->
    <div id="fixModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ› ï¸ è¯†åˆ«ä¿®æ­£</h3>
            <p>åˆšæ‰è¯†åˆ«åˆ°çš„è¯­éŸ³æ˜¯ï¼š<strong id="wrongTranscript" style="color: #d32f2f;"></strong></p>
            <p>è¯·é€‰æ‹©å¯¹åº”çš„æ­£ç¡®å­¦ç”Ÿï¼ˆä¸‹æ¬¡å°†è‡ªåŠ¨è¯†åˆ«ï¼‰ï¼š</p>
            <select id="studentSelect"></select>
            <div class="modal-buttons">
                <button onclick="confirmFix()" class="btn-add">ç¡®è®¤ä¿®æ­£</button>
                <button onclick="closeFixModal()" class="btn-stop">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®å‡†å¤‡ ---
        const studentList = [
            "ç†Šæ¢“æ¶µ", "å¼ æ¢“ç‚Ÿ", "é™ˆç‘¾èŠ®", "å¼ æ·æ–‡", "éƒ­æ°¸éª", "ç‹ç¾ç«¥", "æ¢æ˜è½©", "é¡¾å‡Œä¼Š",
            "èŒƒä¸€è¡Œ", "é™ˆæ¶µé›¨æ¬£", "è´¹å®£åš", "éŸ¦å…ƒæ³½", "å¼ çƒœå®", "å‘å˜‰å®‡", "é™†æ€¡ç…Š", "æ±ªæ™“æ¶µ",
            "å¼ å˜‰ä»", "é«˜é’°æ¶µ", "é¾™ç‘¶ç³", "ç‹åº·å®‡", "ææœæ™º", "æä¿Šä»ª", "æ˜“èŠ¸ç«¹", "è¢å®‡æ³½",
            "ç†Šæ¢“å‡¯", "æé›¨è‹—", "æè‡³åœ£", "å¼ çš“å“²", "ä½•ä¸€å‡¡", "èµµå­çª", "ç”°è¢æ…§èŠ", "æŸ¯ä¹‰æº±"
        ].sort((a, b) => a.localeCompare(b, 'zh-CN'));

        let studentData = {};
        studentList.forEach(name => studentData[name] = 0);

        // è¯†åˆ«æ˜ å°„è¡¨ï¼ˆå­¦ä¹ è®°å¿†ï¼‰
        let recognitionMap = JSON.parse(localStorage.getItem('runCounter_map')) || {};
        
        // é¢„è®¡ç®—æ‰€æœ‰å­¦ç”Ÿçš„æ‹¼éŸ³ï¼Œæé«˜åŒ¹é…æ•ˆç‡
        const { pinyin } = pinyinPro;
        let studentPinyins = {};
        
        // åˆå§‹åŒ–è®¡ç®—æ‹¼éŸ³ï¼ˆå»å£°è°ƒï¼Œç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
        setTimeout(() => {
            studentList.forEach(name => {
                // è·å–ä¸å¸¦å£°è°ƒçš„æ‹¼éŸ³å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "é¡¾å‡Œä¼Š" -> "gulingyi"
                studentPinyins[name] = pinyin(name, { toneType: 'none', type: 'array' }).join('');
            });
            console.log("æ‹¼éŸ³ç´¢å¼•æ„å»ºå®Œæˆ");
        }, 500);

        // --- 2. ç•Œé¢åˆå§‹åŒ– ---
        const grid = document.getElementById('studentGrid');
        const historyBar = document.getElementById('historyBar');
        const historyText = document.getElementById('historyText');
        const studentSelect = document.getElementById('studentSelect');
        const fixModal = document.getElementById('fixModal');

        function initUI() {
            grid.innerHTML = '';
            studentList.forEach(name => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.id = `card-${name}`;
                card.innerHTML = `
                    <div class="student-name">${name}</div>
                    <div class="lap-display" id="count-${name}">0</div>
                    <div class="card-controls">
                        <button class="btn-sm btn-sub" onclick="updateLap('${name}', -1)">-1</button>
                        <button class="btn-sm btn-add" onclick="updateLap('${name}', 1)">+1</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            // å¡«å……ä¿®æ­£ä¸‹æ‹‰æ¡†
            studentSelect.innerHTML = '';
            studentList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                studentSelect.appendChild(option);
            });
        }
        initUI();

        // --- 3. æ ¸å¿ƒé€»è¾‘ï¼šæ›´æ–°åœˆæ•° ---
        // è®°å½•æœ€åä¸€æ¬¡è‡ªåŠ¨è¯†åˆ«çš„æ“ä½œï¼Œç”¨äºæ’¤å›
        let lastAutoAction = null; 

        function updateLap(name, change, isAuto = false) {
            studentData[name] = Math.max(0, studentData[name] + change);
            document.getElementById(`count-${name}`).textContent = studentData[name];

            // è§†è§‰åé¦ˆ
            if (change > 0) {
                const card = document.getElementById(`card-${name}`);
                card.classList.remove('just-updated');
                void card.offsetWidth;
                card.classList.add('just-updated');
                setTimeout(() => card.classList.remove('just-updated'), 2000);
            }
        }

        // --- 4. æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½åŒ¹é… (æ‹¼éŸ³ + å­¦ä¹ ) ---
        function findBestMatch(transcript) {
            // 0. é¢„å¤„ç†
            const cleanText = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚\s]/g,"");
            if (!cleanText) return null;

            // 1. ä¼˜å…ˆæŸ¥â€œå­¦ä¹ è¡¨â€ï¼ˆä¿®æ­£è¿‡çš„è®°å½•ï¼‰
            if (recognitionMap[cleanText]) {
                console.log(`[è®°å¿†åŒ¹é…] ${cleanText} -> ${recognitionMap[cleanText]}`);
                return recognitionMap[cleanText];
            }

            // 2. æ‹¼éŸ³æ¨¡ç³ŠåŒ¹é… (Levenshteinè·ç¦»)
            const inputPinyin = pinyin(cleanText, { toneType: 'none', type: 'array' }).join('');
            
            let bestName = null;
            let minDistance = Infinity;

            studentList.forEach(name => {
                const targetPinyin = studentPinyins[name];
                // è®¡ç®—æ‹¼éŸ³çš„ç¼–è¾‘è·ç¦»
                const dist = levenshtein(inputPinyin, targetPinyin);
                
                // è·ç¦»è¶Šå°è¶ŠåŒ¹é…
                if (dist < minDistance) {
                    minDistance = dist;
                    bestName = name;
                }
            });

            console.log(`[æ‹¼éŸ³åŒ¹é…] è¯­éŸ³:${cleanText}(${inputPinyin}) -> æœ€ä¼¼:${bestName} (è·ç¦»:${minDistance})`);
            
            // åªè¦æœ‰ç»“æœï¼Œå°±è¿”å›æœ€æ¥è¿‘çš„ï¼ˆå› ä¸ºç”¨æˆ·æ‰¿è¯ºåªè¯´è¿™32äººï¼‰
            // è®¾å®šä¸€ä¸ªæå®½çš„é˜ˆå€¼é˜²æ­¢å®Œå…¨ä¸ç›¸å…³çš„å™ªéŸ³ï¼Œæ¯”å¦‚è·ç¦»è¶…è¿‡æ‹¼éŸ³é•¿åº¦çš„ä¸€åŠ
            if (minDistance < inputPinyin.length * 0.8 || minDistance <= 3) {
                return bestName;
            }

            return null;
        }

        // ç¼–è¾‘è·ç¦»ç®—æ³•
        function levenshtein(s, t) {
            const d = [];
            for (let i = 0; i <= s.length; i++) d[i] = [i];
            for (let j = 0; j <= t.length; j++) d[0][j] = j;
            for (let i = 1; i <= s.length; i++) {
                for (let j = 1; j <= t.length; j++) {
                    const cost = s[i - 1] === t[j - 1] ? 0 : 1;
                    d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
                }
            }
            return d[s.length][t.length];
        }

        // --- 5. è¯­éŸ³è¯†åˆ«ä¸ä¿®æ­£é€»è¾‘ ---
        let recognition;
        let isListening = false;

        function toggleSpeech() {
            if (isListening) {
                recognition.stop();
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚");
                return;
            }

            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new Speech();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'zh-CN';

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('voiceBtn').textContent = "ğŸ”´ åœæ­¢ç›‘å¬";
                document.getElementById('voiceStatus').textContent = "ğŸ‘‚ æ­£åœ¨è†å¬...";
                document.getElementById('voiceStatus').classList.add('listening');
            };

            recognition.onend = () => {
                if (isListening) recognition.start(); // è‡ªåŠ¨é‡è¿
                else {
                    document.getElementById('voiceBtn').textContent = "ğŸ™ï¸ å¼€å§‹ç›‘å¬";
                    document.getElementById('voiceStatus').textContent = "ğŸ™ï¸ è¯­éŸ³æœªå¯åŠ¨";
                    document.getElementById('voiceStatus').classList.remove('listening');
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                processVoiceCommand(transcript);
            };

            recognition.start();
        }

        function processVoiceCommand(transcript) {
            const matchName = findBestMatch(transcript);
            
            if (matchName) {
                // æ‰§è¡ŒåŠ åˆ†
                updateLap(matchName, 1, true);
                
                // è®°å½•æ“ä½œä»¥ä¾¿æ’¤å›
                lastAutoAction = {
                    rawText: transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚\s]/g,""),
                    matchedName: matchName,
                    timestamp: Date.now()
                };

                // æ˜¾ç¤ºå†å²æ 
                historyBar.style.display = 'flex';
                historyText.innerHTML = `è¯†åˆ«: "<b>${lastAutoAction.rawText}</b>" â¡ï¸ è®°ç»™: <b style="color:var(--primary-color)">${matchName}</b> (+1)`;
            } else {
                historyBar.style.display = 'flex';
                historyText.innerHTML = `è¯†åˆ«: "<b>${transcript}</b>" â¡ï¸ âŒ æœªåŒ¹é…åˆ°åŒå­¦`;
                lastAutoAction = null; // æ— æ³•æ’¤å›åŠ åˆ†ï¼Œå› ä¸ºæ²¡åŠ ï¼Œä½†å¯ä»¥è€ƒè™‘åšä¸€ä¸ªæ‰‹åŠ¨æ·»åŠ çš„åŠŸèƒ½ï¼ˆæ­¤å¤„æš‚ç•¥ï¼Œä¿æŒç®€æ´ï¼‰
            }
        }

        // --- 6. æ’¤å›ä¿®æ­£åŠŸèƒ½ ---
        function triggerFix() {
            if (!lastAutoAction) return;
            
            // 1. æ’¤å›åˆšæ‰çš„åˆ†æ•°
            updateLap(lastAutoAction.matchedName, -1);
            
            // 2. æ‰“å¼€å¼¹çª—
            document.getElementById('wrongTranscript').textContent = lastAutoAction.rawText;
            // å°è¯•é¢„é€‰ä¸­åˆšæ‰é”™è¯¯çš„åŒ¹é…é¡¹
            studentSelect.value = lastAutoAction.matchedName;
            fixModal.style.display = 'flex';
        }

        function confirmFix() {
            const correctName = studentSelect.value;
            const wrongText = lastAutoAction.rawText;

            // 1. åŠ ä¸Šæ­£ç¡®çš„åˆ†æ•°
            updateLap(correctName, 1);

            // 2. è®°ä½è¿™ä¸ªæ˜ å°„ï¼ˆå­¦ä¹ ï¼‰
            recognitionMap[wrongText] = correctName;
            localStorage.setItem('runCounter_map', JSON.stringify(recognitionMap));

            // 3. UIåé¦ˆ
            historyText.innerHTML = `å·²ä¿®æ­£: "${wrongText}" ä»¥åå°†è‡ªåŠ¨è¯†åˆ«ä¸º <b>${correctName}</b>`;
            
            closeFixModal();
        }

        function closeFixModal() {
            fixModal.style.display = 'none';
        }

        function resetRecognitionMap() {
            if(confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ‰‹åŠ¨çš„è¯­éŸ³ä¿®æ­£è®°å½•å—ï¼Ÿ")) {
                recognitionMap = {};
                localStorage.removeItem('runCounter_map');
                alert("è®°å¿†å·²æ¸…é™¤");
            }
        }

        // --- 7. å…¨å±€æ§åˆ¶ ---
        function globalChange(val) {
            studentList.forEach(n => updateLap(n, val));
        }
        function globalReset() {
            if(confirm("ç¡®è®¤æ¸…é›¶å…¨ç­æ•°æ®ï¼Ÿ")) {
                studentList.forEach(name => {
                    studentData[name] = 0;
                    document.getElementById(`count-${name}`).textContent = 0;
                });
            }
        }

        // --- 8. ç…§ç‰‡å¤„ç† ---
        function handlePhotos(input) {
            const gallery = document.getElementById('photoGallery');
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.onclick = () => {
                            // ç‚¹å‡»å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹ï¼ˆç®€å•çš„å…¨å±é€»è¾‘æˆ–è€…å¤§å›¾é€»è¾‘ï¼‰
                            const w = window.open("");
                            w.document.write(`<img src="${e.target.result}" style="width:100%">`);
                        };
                        gallery.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
    </script>
</body>
</html>
