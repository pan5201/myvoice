<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>åˆä¸‰9ç­æ™ºèƒ½è¯­éŸ³è·‘åœˆè®¡æ•°å™¨ï¼ˆæ‰‹æœºå…¼å®¹ç‰ˆï¼‰</title>  
    <!-- å¼•å…¥æ‹¼éŸ³åº“ -->  
    <script src="https://unpkg.com/pinyin-pro"></script>  
    <style>  
        :root {  
            --primary-color: #4CAF50;  
            --danger-color: #f44336;  
            --bg-color: #f0f2f5;  
            --card-bg: #ffffff;  
            --highlight-color: #2196F3;  
        }  
  
        body {  
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;  
            background-color: var(--bg-color);  
            margin: 0;  
            padding: 10px;  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            padding-bottom: 100px; /* åº•éƒ¨ç•™ç™½ç»™æ—¥å¿— */  
        }  
  
        h1 { color: #333; margin: 10px 0; font-size: 1.5rem; text-align: center; }  
  
        /* æ§åˆ¶é¢æ¿ */  
        .control-panel {  
            background: var(--card-bg);  
            padding: 15px;  
            border-radius: 12px;  
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);  
            position: sticky;  
            top: 0;  
            z-index: 100;  
            width: 100%;  
            max-width: 600px;  
            display: flex;  
            flex-direction: column;  
            gap: 10px;  
            margin-bottom: 15px;  
        }  
  
        .status-bar {  
            display: flex;  
            justify-content: space-between;  
            align-items: center;  
            background: #f5f5f5;  
            padding: 8px 12px;  
            border-radius: 8px;  
        }  
  
        .voice-status {  
            font-weight: bold;  
            color: #666;  
            font-size: 0.9rem;  
            display: flex;  
            align-items: center;  
        }  
  
        .voice-status.listening { color: var(--primary-color); }  
        .voice-status.listening::before {  
            content: '';  
            display: inline-block;  
            width: 10px;  
            height: 10px;  
            border-radius: 50%;  
            background-color: var(--primary-color);  
            margin-right: 6px;  
            box-shadow: 0 0 8px var(--primary-color);  
            animation: pulse 1s infinite;  
        }  
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }  
  
        /* æŒ‰é’®ç»„ */  
        .btn-group {  
            display: grid;  
            grid-template-columns: 1fr 1fr;  
            gap: 10px;  
        }  
          
        .btn-row {  
            display: flex;  
            gap: 8px;  
            justify-content: space-between;  
        }  
  
        button {  
            border: none;  
            padding: 12px;  
            border-radius: 8px;  
            font-size: 14px;  
            color: white;  
            font-weight: bold;  
            touch-action: manipulation; /* ä¼˜åŒ–è§¦å±ç‚¹å‡» */  
        }  
        button:active { opacity: 0.7; transform: scale(0.98); }  
  
        .btn-start { background-color: var(--primary-color); grid-column: span 2; font-size: 1.1rem; }  
        .btn-stop { background-color: #9e9e9e; grid-column: span 2; }  
        .btn-global-add { background-color: var(--highlight-color); flex: 1; }  
        .btn-global-reset { background-color: var(--danger-color); flex: 1; }  
        .btn-fix {   
            background-color: #FF9800;   
            width: 100%;   
            margin-top: 5px;  
            display: none; /* é»˜è®¤éšè— */  
        }  
  
        /* è°ƒè¯•æ—¥å¿— */  
        .debug-log {  
            font-size: 12px;  
            color: #888;  
            background: #eee;  
            padding: 5px;  
            border-radius: 4px;  
            max-height: 60px;  
            overflow-y: auto;  
            margin-top: 5px;  
            font-family: monospace;  
        }  
  
        /* å­¦ç”Ÿåˆ—è¡¨ */  
        .grid-container {  
            display: grid;  
            grid-template-columns: repeat(2, 1fr); /* æ‰‹æœºä¸¤åˆ— */  
            gap: 10px;  
            width: 100%;  
            max-width: 600px;  
        }  
        @media (min-width: 600px) {  
            .grid-container { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }  
        }  
  
        .student-card {  
            background: var(--card-bg);  
            border-radius: 8px;  
            padding: 10px;  
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);  
            text-align: center;  
            border: 2px solid transparent;  
            transition: transform 0.2s;  
        }  
        .student-card.just-updated {  
            background-color: #e8f5e9;  
            border-color: var(--primary-color);  
            transform: scale(1.02);  
        }  
  
        .student-name { font-size: 1.1em; font-weight: bold; color: #333; }  
        .lap-display { font-size: 2em; font-weight: bold; color: var(--primary-color); margin: 2px 0; }  
          
        .card-controls { display: flex; gap: 5px; justify-content: center; margin-top: 5px; }  
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 4px; }  
        .btn-add { background-color: var(--primary-color); }  
        .btn-sub { background-color: #FF9800; }  
  
        /* ç…§ç‰‡åŒºåŸŸ */  
        .photo-area {  
            border-top: 1px dashed #ccc;  
            padding-top: 10px;  
            text-align: center;  
        }  
        .photo-input-label {  
            display: inline-block;  
            background: #607D8B;  
            color: white;  
            padding: 8px 15px;  
            border-radius: 20px;  
            font-size: 0.9rem;  
        }  
        .photo-gallery {  
            display: flex;  
            overflow-x: auto;  
            gap: 8px;  
            padding: 10px 0;  
        }  
        .photo-gallery img {  
            height: 100px;  
            border-radius: 4px;  
            border: 1px solid #ddd;  
        }  
  
        /* å¼¹çª— */  
        .modal {  
            display: none;  
            position: fixed;  
            top: 0; left: 0; width: 100%; height: 100%;  
            background: rgba(0,0,0,0.6);  
            z-index: 1000;  
            justify-content: center;  
            align-items: center;  
        }  
        .modal-content {  
            background: white;  
            padding: 20px;  
            border-radius: 12px;  
            width: 85%;  
            max-width: 320px;  
            text-align: center;  
        }  
        .modal select {  
            width: 100%;  
            padding: 10px;  
            margin: 15px 0;  
            font-size: 16px;  
            border: 1px solid #ccc;  
        }  
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }  
    </style>  
</head>  
<body>  
  
    <h1>ğŸƒâ€â™‚ï¸ åˆä¸‰9ç­è¯­éŸ³è·‘åœˆè®¡æ•° (æ‰‹æœºå…¼å®¹ç‰ˆ)</h1>  
  
    <div class="control-panel">  
        <div class="status-bar">  
            <div id="voiceStatus" class="voice-status">ğŸ™ï¸ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</div>  
            <div style="font-size:0.8rem; color:#999;" id="wakeLockStatus">å±å¹•å¸¸äº®: æœªæ¿€æ´»</div>  
        </div>  
  
        <div id="debugLog" class="debug-log">æ—¥å¿—çª—å£: ç­‰å¾…æ“ä½œ...</div>  
  
        <div class="btn-group">  
            <button onclick="toggleSpeech()" id="voiceBtn" class="btn-start">ğŸ™ï¸ å¼€å¯è¯­éŸ³ç›‘å¬</button>  
        </div>  
  
        <button id="fixBtn" class="btn-fix" onclick="triggerFix()">âŒ æ’¤å›åˆšæ‰çš„è¯†åˆ«å¹¶ä¿®æ­£</button>  
  
        <div class="btn-row">  
            <button onclick="globalChange(1)" class="btn-global-add">å…¨ç­ +1</button>  
            <button onclick="globalReset()" class="btn-global-reset">æ¸…é›¶</button>  
        </div>  
  
        <div class="photo-area">  
            <label class="photo-input-label">  
                ğŸ“· æ·»åŠ ç…§ç‰‡  
                <input type="file" multiple accept="image/*" style="display: none;" onchange="handlePhotos(this)">  
            </label>  
            <div class="photo-gallery" id="photoGallery"></div>  
        </div>  
    </div>  
  
    <div class="grid-container" id="studentGrid"></div>  
  
    <div id="fixModal" class="modal">  
        <div class="modal-content">  
            <h3>ğŸ› ï¸ è¯†åˆ«ä¿®æ­£</h3>  
            <p>è¯†åˆ«æ–‡æœ¬ï¼š<strong id="wrongTranscript" style="color: #d32f2f;"></strong></p>  
            <p>è¯·é€‰æ‹©æ­£ç¡®å­¦ç”Ÿï¼š</p>  
            <select id="studentSelect"></select>  
            <div class="modal-buttons">  
                <button onclick="confirmFix()" class="btn-add">ç¡®è®¤</button>  
                <button onclick="closeFixModal()" class="btn-stop">å–æ¶ˆ</button>  
            </div>  
        </div>  
    </div>  
  
    <script>  
        // --- 1. æ•°æ®ä¸åˆå§‹åŒ– ---  
        const studentList = [  
            "ç†Šæ¢“æ¶µ", "å¼ æ¢“ç‚Ÿ", "é™ˆç‘¾èŠ®", "å¼ æ·æ–‡", "éƒ­æ°¸éª", "ç‹ç¾ç«¥", "æ¢æ˜è½©", "é¡¾å‡Œä¼Š",  
            "èŒƒä¸€è¡Œ", "é™ˆæ¶µé›¨æ¬£", "è´¹å®£åš", "éŸ¦å…ƒæ³½", "å¼ çƒœå®", "å‘å˜‰å®‡", "é™†æ€¡ç…Š", "æ±ªæ™“æ¶µ",  
            "å¼ å˜‰ä»", "é«˜é’°æ¶µ", "é¾™ç‘¶ç³", "ç‹åº·å®‡", "ææœæ™º", "æä¿Šä»ª", "æ˜“èŠ¸ç«¹", "è¢å®‡æ³½",  
            "ç†Šæ¢“å‡¯", "æé›¨è‹—", "æè‡³åœ£", "å¼ çš“å“²", "ä½•ä¸€å‡¡", "èµµå­çª", "ç”°è¢æ…§èŠ", "æŸ¯ä¹‰æº±"  
        ].sort((a, b) => a.localeCompare(b, 'zh-CN'));  
  
        let studentData = {};  
        let recognitionMap = JSON.parse(localStorage.getItem('runCounter_map')) || {};  
        let studentPinyins = {};  
        const { pinyin } = pinyinPro;  
  
        setTimeout(() => {  
            studentList.forEach(name => {  
                studentData[name] = 0;  
                studentPinyins[name] = pinyin(name, { toneType: 'none', type: 'array' }).join('');  
            });  
            initUI();  
            logDebug("ç³»ç»Ÿå°±ç»ªï¼Œæ‹¼éŸ³ç´¢å¼•å·²æ„å»º");  
        }, 500);  
  
        const grid = document.getElementById('studentGrid');  
        const debugEl = document.getElementById('debugLog');  
        const fixBtn = document.getElementById('fixBtn');  
  
        function logDebug(msg) {  
            const time = new Date().toLocaleTimeString();  
            debugEl.textContent = `[${time}] ${msg}`;  
        }  
  
        function initUI() {  
            grid.innerHTML = '';  
            const select = document.getElementById('studentSelect');  
            select.innerHTML = '';  
            studentList.forEach(name => {  
                const card = document.createElement('div');  
                card.className = 'student-card';  
                card.id = `card-${name}`;  
                card.innerHTML = `  
                    <div class="student-name">${name}</div>  
                    <div class="lap-display" id="count-${name}">0</div>  
                    <div class="card-controls">  
                        <button class="btn-sm btn-sub" onclick="updateLap('${name}', -1)">-</button>  
                        <button class="btn-sm btn-add" onclick="updateLap('${name}', 1)">+</button>  
                    </div>  
                `;  
                grid.appendChild(card);  
                const option = document.createElement('option');  
                option.value = name;  
                option.textContent = name;  
                select.appendChild(option);  
            });  
        }  
  
        function updateLap(name, change, isAuto = false) {  
            if(!studentData[name] && studentData[name] !== 0) return;  
            studentData[name] = Math.max(0, studentData[name] + change);  
            document.getElementById(`count-${name}`).textContent = studentData[name];  
            if (change > 0) {  
                const card = document.getElementById(`card-${name}`);  
                card.classList.remove('just-updated');  
                void card.offsetWidth;  
                card.classList.add('just-updated');  
                if(isAuto) card.scrollIntoView({ behavior: "smooth", block: "center" });  
                setTimeout(() => card.classList.remove('just-updated'), 1000);  
            }  
        }  
  
        // --- æ ¸å¿ƒè¯†åˆ«æ§åˆ¶éƒ¨åˆ† ---  
        let recognition;  
        let isListening = false;  
        let wakeLock = null;  
        let restartTimer = null; // ç”¨äºç®¡ç†é‡å¯  
  
        async function requestWakeLock() {  
            try {  
                if ('wakeLock' in navigator) {  
                    wakeLock = await navigator.wakeLock.request('screen');  
                    document.getElementById('wakeLockStatus').textContent = "å±å¹•å¸¸äº®: âœ…";  
                }  
            } catch (err) {}  
        }  
  
        function toggleSpeech() {  
            if (isListening) {  
                isListening = false;  
                if (restartTimer) clearTimeout(restartTimer);  
                if (recognition) recognition.stop();  
                updateBtnState();  
                logDebug("ç›‘å¬å·²æ‰‹åŠ¨åœæ­¢");  
            } else {  
                startRecognition();  
            }  
        }  
  
        function startRecognition() {  
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {  
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆChromeæˆ–Edgeã€‚");  
                return;  
            }  
  
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;  
              
            // å¦‚æœå·²æœ‰å®ä¾‹ï¼Œå…ˆå¼ºåˆ¶é”€æ¯  
            if (recognition) {  
                recognition.abort();  
            }  
  
            recognition = new Speech();  
            recognition.continuous = false; // æ‰‹æœºç«¯ false æ›´ç¨³å®š  
            recognition.interimResults = false;   
            recognition.lang = 'zh-CN';  
  
            recognition.onstart = () => {  
                isListening = true;  
                updateBtnState();  
                requestWakeLock();  
                logDebug("ç›‘å¬ä¸­ï¼Œè¯·æŠ¥åå­—...");  
            };  
  
            recognition.onerror = (event) => {  
                if (event.error === 'aborted') {  
                    // é™é»˜è®°å½•ä¸­æ–­ï¼Œä¸æ”¹å˜æŒ‰é’®çŠ¶æ€  
                    logDebug("ç³»ç»Ÿè°ƒåº¦ä¸­æ–­ï¼Œå‡†å¤‡è‡ªåŠ¨é‡è¿...");  
                } else {  
                    logDebug(`è¯†åˆ«é”™è¯¯: ${event.error}`);  
                    if (event.error === 'not-allowed') alert("è¯·å¼€å¯éº¦å…‹é£æƒé™ï¼");  
                }  
            };  
  
            recognition.onresult = (event) => {  
                const transcript = event.results[event.results.length - 1][0].transcript.trim();  
                logDebug(`å¬åˆ°: "${transcript}"`);  
                processVoiceCommand(transcript);  
            };  
  
            recognition.onend = () => {  
                // å¦‚æœ isListening ä»ä¸ºçœŸï¼Œè¯´æ˜æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ–­å¼€æˆ–è¯†åˆ«å®Œæˆï¼Œéœ€è¦å¾ªç¯å¯åŠ¨  
                if (isListening) {  
                    if (restartTimer) clearTimeout(restartTimer);  
                    restartTimer = setTimeout(() => {  
                        if (isListening) {  
                            try {  
                                recognition.start();  
                            } catch(e) {  
                                logDebug("é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®");  
                                isListening = false;  
                                updateBtnState();  
                            }  
                        }  
                    }, 300); // 300ms é—´éš”ï¼Œé˜²æ­¢å®‰å“å¼•æ“å“åº”ä¸åŠæ—¶  
                } else {  
                    updateBtnState();  
                }  
            };  
  
            try {  
                recognition.start();  
            } catch (e) {  
                logDebug("å¼•æ“å¿™ï¼Œè¯·é‡è¯•");  
            }  
        }  
  
        function updateBtnState() {  
            const btn = document.getElementById('voiceBtn');  
            const status = document.getElementById('voiceStatus');  
            if (isListening) {  
                btn.textContent = "ğŸ”´ åœæ­¢ç›‘å¬";  
                btn.className = "btn-stop";  
                status.textContent = "ğŸ‘‚ æ­£åœ¨è†å¬...";  
                status.classList.add('listening');  
            } else {  
                btn.textContent = "ğŸ™ï¸ å¼€å¯è¯­éŸ³ç›‘å¬";  
                btn.className = "btn-start";  
                status.textContent = "ğŸ™ï¸ ç‚¹å‡»å¼€å¯";  
                status.classList.remove('listening');  
            }  
        }  
  
        // --- ä¸šåŠ¡é€»è¾‘ä¿æŒåŸæ · ---  
        let lastAutoAction = null;   
  
        function processVoiceCommand(transcript) {  
            const cleanText = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚\s]/g,"");  
            let matchName = null;  
            if (recognitionMap[cleanText]) {  
                matchName = recognitionMap[cleanText];  
            } else {  
                const inputPinyin = pinyin(cleanText, { toneType: 'none', type: 'array' }).join('');  
                let minDist = Infinity;  
                studentList.forEach(name => {  
                    const target = studentPinyins[name];  
                    const dist = levenshtein(inputPinyin, target);  
                    if (dist < minDist) {  
                        minDist = dist;  
                        matchName = name;  
                    }  
                });  
                if (minDist > 4) matchName = null;   
            }  
  
            if (matchName) {  
                updateLap(matchName, 1, true);  
                lastAutoAction = { raw: cleanText, name: matchName };  
                fixBtn.style.display = 'block';  
                fixBtn.textContent = `æ’¤å› "${cleanText}" -> ${matchName}`;  
            } else {  
                logDebug("æœªåŒ¹é…åˆ°åå­—");  
            }  
        }  
  
        function levenshtein(s, t) {  
            const d = [];  
            for (let i = 0; i <= s.length; i++) d[i] = [i];  
            for (let j = 0; j <= t.length; j++) d[0][j] = j;  
            for (let i = 1; i <= s.length; i++) {  
                for (let j = 1; j <= t.length; j++) {  
                    const cost = s[i - 1] === t[j - 1] ? 0 : 1;  
                    d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);  
                }  
            }  
            return d[s.length][t.length];  
        }  
  
        function triggerFix() {  
            if (!lastAutoAction) return;  
            updateLap(lastAutoAction.name, -1);  
            document.getElementById('wrongTranscript').textContent = lastAutoAction.raw;  
            document.getElementById('studentSelect').value = lastAutoAction.name;  
            document.getElementById('fixModal').style.display = 'flex';  
        }  
  
        function confirmFix() {  
            const correctName = document.getElementById('studentSelect').value;  
            const wrongText = lastAutoAction.raw;  
            updateLap(correctName, 1, true);  
            recognitionMap[wrongText] = correctName;  
            localStorage.setItem('runCounter_map', JSON.stringify(recognitionMap));  
            closeFixModal();  
        }  
  
        function closeFixModal() {  
            document.getElementById('fixModal').style.display = 'none';  
            fixBtn.style.display = 'none';  
        }  
  
        function globalChange(val) { studentList.forEach(n => updateLap(n, val)); }  
        function globalReset() { if(confirm("æ¸…é›¶å…¨ç­æ•°æ®?")) studentList.forEach(n => updateLap(n, -studentData[n])); }  
  
        function handlePhotos(input) {  
            const gallery = document.getElementById('photoGallery');  
            if (input.files) {  
                Array.from(input.files).forEach(file => {  
                    const reader = new FileReader();  
                    reader.onload = function(e) {  
                        const img = document.createElement('img');  
                        img.src = e.target.result;  
                        gallery.appendChild(img);  
                    }  
                    reader.readAsDataURL(file);  
                });  
            }  
        }  
    </script>  
</body>  
</html>  
